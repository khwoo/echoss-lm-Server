<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"> 

<mapper namespace="client">
	
	<!-- ======================================================================================================= -->
	<!-- 											CMS 관리														 -->
	<!-- ======================================================================================================= -->
	<select id="selectCmsInfo"  parameterType="map" resultType="hashMap">
		SELECT *
		FROM WGTB_CMS_INFO
		WHERE CMS_ID = #{tid}
		AND USE_YN = 'Y'
	</select>
	<select id="selectCmsDetailListInfo" parameterType="map" resultType="hashMap">
		
		SELECT
			*
		FROM
			WGTB_CMS_DTL_INFO A
		WHERE
			A.CMS_ID = #{tid}
		AND
			A.USE_YN = 'Y'
		ORDER BY DIP_ORD
	</select>
	<!-- ======================================================================================================= -->
	<!-- 											PROMOTION 관리												 -->
	<!-- ======================================================================================================= -->
	<!-- promotion list 정보 조회 -->
	<select id="selectProMotionListInfo" parameterType="map" resultType="hashMap">
		SELECT
			*
		FROM
			WGTB_PRMT_INFO
		WHERE
			ST_CD = '1'
AND DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN ST_DT AND EN_DT
	</select>
	<!-- ======================================================================================================= -->
	<!-- 											배너 관리														 -->
	<!-- ======================================================================================================= -->
	
	<!-- 배너 상세 정보 조회 -->
	<select id="selectBanrDetailInfo" parameterType="map" resultType="hashMap" >
		
		SELECT
			*
		FROM
			WGTB_BANR_INFO A
		WHERE
			A.BANR_CD = #{bnrCd}
		
	</select>
	<!-- 배너 상세 이미지 정보 조회 -->
	<select id="selectBanrDetailImageListInfo" parameterType="map" resultType="hashMap">
	
		SELECT
			*
		FROM
			WGTB_BANR_IMG_INFO A
		WHERE
			A.BANR_CD = #{bnrCd}
		
	
	</select>
	
	<!-- ======================================================================================================= -->
	<!-- 											MY 관리														 -->
	<!-- ======================================================================================================= -->
	<!-- my page place data -->
	<select id="selectMyPagePlaceListInfo" parameterType="map" resultType="hashMap">
		SELECT
		  	*
		FROM
		  	WGTB_USER_MCHT_INFO A
		  	LEFT JOIN WGTB_MCHT_INFO B ON B.MCHT_CD = A.MCHT_CD
		WHERE
		  	A.USER_ID = #{userId}
	</select>
	<!-- my page place Tag data -->
	<select id="selectMyPagePlaceTagListInfo" parameterType="map" resultType="hashMap">
	
		SELECT
		  *
		FROM
		  WGTB_MCHT_TAG_INFO A
		  LEFT JOIN WGTB_TAG_INFO B ON B.TAG_CD = A.TAG_CD
		WHERE
		  A.MCHT_CD IN
		  	<foreach collection="MctCd" item="item" index="index" separator="," open="(" close=")" >
			  		#{item}
			</foreach> 
		AND
		  B.ST_CD = '1'
		
	</select>
	<!-- my page tour data -->
	<select id="selectMyPageTourListInfo" parameterType="map" resultType="hashMap">
		SELECT
		  	*
		FROM
		  	WGTB_USER_TOUR_INFO A
		  	LEFT JOIN WGTB_TOUR_INFO B ON B.TOUR_CD = A.TOUR_CD
		WHERE
		  	A.USER_ID = #{userId}
	</select>
	<!--  my page tour mcht data -->
	<select id="selectMyPageTourMchtListInfo" parameterType="map" resultType="hashMap">
		SELECT
		  	*
		FROM
		  	WGTB_TOUR_MCHT_INFO A
		  	LEFT JOIN WGTB_MCHT_INFO B ON B.MCHT_CD = A.MCHT_CD
		WHERE
		 	 A.TOUR_CD IN 
		 	 <foreach collection="TourCd" item="item" index="index" separator="," open="(" close=")" >
		  		#{item}
		  	</foreach>
		ORDER BY TOUR_ORDER
	</select>
	<!-- ======================================================================================================= -->
	<!-- 											TOUR 관리														 -->
	<!-- ======================================================================================================= -->
	<!-- tour mct 목록 조회 -->
	<select id="selectTourMctList" parameterType="map" resultType="hashMap">
		SELECT
		  *
		FROM
			  WGTB_MCHT_INFO A,
			  WGTB_TOUR_MCHT_INFO B
		WHERE
		 	 A.MCHT_CD = B.MCHT_CD
		AND
		 	 A.ST_CD = '1'
		<if test=" searchAreaCd != null and searchAreaCd != '' ">
		AND
		 	 A.AREA_CD = #{searchAreaCd}
		</if>
		
	</select>
	<!-- tour 의 정보 목록 조회 -->
	<select id="selectTourMctInfoList" parameterType="map" resultType="hashMap">
		SELECT
		  *
		FROM
			  WGTB_MCHT_INFO A,
			  WGTB_TOUR_MCHT_INFO B
		WHERE
		 	 A.MCHT_CD = B.MCHT_CD
		AND
		 	 A.ST_CD = '1'
		AND
		B.TOUR_CD IN
		  	<foreach collection="TourCd" item="item" index="index" separator="," open="(" close=")" >
		  		#{item}
		  	</foreach>
		ORDER BY B.TOUR_ORDER
	</select>
	<!-- tour 목록 조회 -->
	<select id="selectTourList" parameterType="map" resultType="hashMap">
		
		SELECT
		  	*
		  	,(CASE WHEN (SELECT COUNT(*) FROM WGTB_USER_TOUR_INFO A WHERE USER_ID = #{userId} AND A.TOUR_CD = B.TOUR_CD) > 0 THEN 'Y' ELSE 'N' END ) AS FVR_YN
		FROM
		  	WGTB_TOUR_INFO B
		WHERE
		 	B.ST_CD = '1'
	  	AND
		  	B.TOUR_CD IN
		  	<foreach collection="TourCd" item="item" index="index" separator="," open="(" close=")" >
		  		#{item}
		  	</foreach>
		ORDER BY 
			B.RCMD_YN 
		DESC
	
	</select>
	<!-- 유저 tour 정보 건수 조회 -->
	<select id="selectUserMyTourFavoriteCnt" parameterType="map" resultType="int">
		SELECT
		 	 COUNT(*)
		FROM
		  	WGTB_USER_TOUR_INFO
		WHERE
		 	 USER_ID = #{userId}
		
	</select>
	<!-- 유저 지역 정보 건수  조회 -->
	<select id="selectUserPlaceFavoriteCnt" parameterType="map" resultType="int">
		SELECT
		 	 COUNT(*)
		FROM
		  	WGTB_USER_MCHT_INFO
		WHERE
		 	 USER_ID = #{userId}
		
	</select>
	<!-- 유저 지역 정보 삭제  -->
	<select id="deletetUserPlaceFavorite" parameterType="map">
	
		DELETE
		FROM
		 	 WGTB_USER_MCHT_INFO
		WHERE
		  	USER_ID = #{userId}
		AND
		  	MCHT_CD = #{mchtCd}
		
	</select>
	<!-- 유저 tour 정보 조회 -->
	<select id="selectUserTourFavoriteCnt" parameterType="map" resultType="int">
		SELECT
		 	 COUNT(*)
		FROM
		  	WGTB_USER_TOUR_INFO
		WHERE
		 	 USER_ID = #{userId}
		AND 
		  	TOUR_CD = #{tourCd}
		
	</select>
	<!-- 유저 tour 정보 삭제 -->
	<select id="deleteUserTourFavorite" parameterType="map">
		
		DELETE
		FROM
		 	 WGTB_USER_TOUR_INFO
		WHERE
		  	USER_ID = #{userId}
		AND
		  	TOUR_CD = #{tourCd}
		
	</select>
	<!-- 유저 tour 정보 등록 -->
	<select id="insertUserTourFavorite" parameterType="map">
		
		
		INSERT INTO 
			WGTB_USER_TOUR_INFO
								(
								USER_ID,
                                TOUR_CD,
                                REG_DT,
                                REG_TM)
                                VALUES(
                                #{userId},
                                #{tourCd},
                                DATE_FORMAT(NOW(),'%Y%m%d'),
                                DATE_FORMAT(NOW(),'%H%i%s')
                                )
		
	</select>
	
	<!-- tour 정보 조회 -->
	<select id="selectTourInfo" parameterType="map" resultType="hashMap">
		
		 SELECT
		  	 *
		   	 ,(CASE WHEN (SELECT COUNT(*) FROM WGTB_USER_TOUR_INFO A WHERE USER_ID = #{userId} AND A.TOUR_CD = B.TOUR_CD) > 0 THEN 'Y' ELSE 'N' END ) AS FVR_YN
		 FROM
		  	 WGTB_TOUR_INFO B
		 WHERE
		  	 B.ST_CD = '1'
		 AND
		  	B.TOUR_CD = #{tourCd}
			
	</select>
	
	<!-- tour 상세 정보 조회  -->
	<select id="selectTourDetailMoreInfo" parameterType="map" resultType="hashMap">
	
		SELECT
		 	*
		FROM
		  	WGTB_MCHT_INFO A
		WHERE
		  	A.MCHT_CD = #{tourMctCd}
		
	</select>
	
	<!-- tour 상세 이미지 정보 조회 -->
	<select id="selectTourDetailMoreImageListInfo" parameterType="map" resultType="hashMap">
	
		SELECT
		  	*
		FROM
		 	 WGTB_MCHT_IMG_INFO A
		WHERE
		  	A.MCHT_CD = #{tourMctCd}
	
	</select>
	<!-- tour 상세 정보 조회 -->
	<select id="selectTourDetailListInfo" parameterType="map" resultType="hashMap">
	
		SELECT
		  	*
		FROM
		  	WGTB_TOUR_MCHT_INFO A
		  	LEFT JOIN WGTB_MCHT_INFO B ON B.MCHT_CD = A.MCHT_CD
		WHERE
		  	A.TOUR_CD = #{tourCd}
		ORDER BY 
			A.TOUR_ORDER
		
	</select>
	
	<!-- tour mct 정보 조회 -->
	<select id="selectTourDetailMctInfoList" parameterType="map" resultType="hashMap">
		SELECT
		  *
		FROM
	   		WGTB_TOUR_MCHT_INFO A
	   		LEFT JOIN WGTB_MCHT_INFO B ON B.MCHT_CD = A.MCHT_CD
	 	WHERE
	   		A.TOUR_CD = #{tourCd}
	 	AND
	   		B.ST_CD = '1'
	   	ORDER BY 
	   		TOUR_ORDER
	</select>
	
	<!-- tour banr 정보 조회 -->
	<select id="selectTourBanrInfoList" parameterType="map" resultType="hashMap">
		SELECT
	  	 	*
	 	FROM
	   		WGTB_BANR_INFO
	 	WHERE
	   		ST_CD = '1'
	 	AND
	    	CONN_TYP = '4'
	 	ORDER BY 
	 		BANR_ORDER
	</select>
	<!-- ======================================================================================================= -->
	<!-- 											가맹점 관리													 -->
	<!-- ======================================================================================================= -->
	<!-- 가맹점 목록 총건수 조회 -->
	<select id="countMerchantList"  parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM WGTB_MCHT_INFO
		WHERE ST_CD = '1'
		<if test="searchTagCd != null and searchTagCd.size != 0">
		AND MCHT_CD IN (
						SELECT MCHT_CD
						FROM WGTB_MCHT_TAG_INFO
						WHERE TAG_CD IN
							<foreach collection="searchTagCd" item="item" index="index" separator="," open="(" close=")">
					            #{item}
					        </foreach>
						)
		</if>
		<if test="searchAreaCd != null and searchAreaCd != ''">
		AND AREA_CD = #{searchAreaCd}
		</if>
	</select>
	
	<!-- 가맹점 목록 조회 -->
	<select id="selectMerchantList"  parameterType="map" resultType="hashMap">
		SELECT *
				,(SELECT IMG_URL FROM WGTB_MCHT_IMG_INFO WHERE MCHT_CD = A.MCHT_CD AND SEQ_NO = '1') AS MCHT_IMG
				,(SELECT IFNULL(GROUP_CONCAT(CONCAT('#', T2.TAG_NM) SEPARATOR ' '), '') FROM WGTB_MCHT_TAG_INFO T1, WGTB_TAG_INFO T2 WHERE T1.TAG_CD = T2.TAG_CD AND T1.MCHT_CD = A.MCHT_CD) AS TAG
				,(CASE WHEN (SELECT COUNT(*) FROM WGTB_USER_MCHT_INFO WHERE USER_ID = #{userId} AND MCHT_CD = A.MCHT_CD) > 0 THEN 'Y' ELSE 'N' END ) AS FVR_YN
		FROM WGTB_MCHT_INFO A
		WHERE ST_CD = '1'
		AND DIV_CD = 'M'
		<if test="searchTagCd != null and searchTagCd.size != 0">
		AND MCHT_CD IN (
						SELECT MCHT_CD
						FROM WGTB_MCHT_TAG_INFO
						WHERE TAG_CD IN
							<foreach collection="searchTagCd" item="item" index="index" separator="," open="(" close=")">
					            #{item}
					        </foreach>
						)
		</if>
		<if test="searchAreaCd != null and searchAreaCd != ''">
		AND A.AREA_CD = #{searchAreaCd}
		</if>
	<!--  	LIMIT <if test="lastID != null and lastID !='' "> #{lastID} , </if>10	-->
	</select>

	<!-- 가맹점 정보 조회 -->
	<select id="selectMerchantInfo"  parameterType="map" resultType="hashMap">
		SELECT A.*
				,(CASE WHEN (SELECT COUNT(*) FROM WGTB_USER_MCHT_INFO WHERE USER_ID = #{userId} AND MCHT_CD = A.MCHT_CD) > 0 THEN 'Y' ELSE 'N' END ) AS FVR_YN
		FROM WGTB_MCHT_INFO A
		WHERE MCHT_CD = #{mchtCd}
	</select>
	
	<!-- 가맹점 이미지 목록 조회 -->
	<select id="selectMerchantImgList"  parameterType="map" resultType="hashMap">
		SELECT MCHT_CD
				,SEQ_NO
				,IMG_URL
		FROM WGTB_MCHT_IMG_INFO
		WHERE MCHT_CD = #{mchtCd}
		ORDER BY SEQ_NO
	</select>
	
	<!-- 매장 접속건수 증가 -->
	<update id="updateBrInfoForConnCnt" parameterType="map">
		UPDATE EWST_BR_INFO
		SET CONN_CNT = CONN_CNT + 1
		WHERE BR_ID = #{brId}
	</update>
	
	<!-- 가맹점 태그 목록 조회 -->
	<select id="selectMerchantTagList"  parameterType="map" resultType="hashMap">
		SELECT C.TAG_CD
				,C.TAG_NM
				,'N' AS ON_YN
		FROM WGTB_MCHT_INFO A, WGTB_MCHT_TAG_INFO B, WGTB_TAG_INFO C
		WHERE A.MCHT_CD = B.MCHT_CD
		AND B.TAG_CD = C.TAG_CD
		AND A.ST_CD = '1'
		<if test="searchAreaCd != null and searchAreaCd != ''">
		AND A.AREA_CD = #{searchAreaCd}
		</if>
		GROUP BY C.TAG_CD
		ORDER BY C.TAG_NM ASC
	</select>
	
	<!-- ======================================================================================================= -->
	<!-- 											사용자 관리													 -->
	<!-- ======================================================================================================= -->
	<!-- 사용자 정보 등록 -->
	<insert id="insertUserInfo" parameterType="map">
		INSERT INTO WGTB_USER_INFO	(
										USER_ID
										,NICKNAME
										,SEX
										,LANG
										,COUNTRY
										,PROV
										,CITY
										,PROFILE_IMG_URL
										,REG_DT
										,REG_TM
											)
							VALUES	(
										#{userId}
										,#{nickname}
										,#{sex}
										,#{lang}
										,#{country}
										,#{prov}
										,#{city}
										,#{profileImgUrl}
										,DATE_FORMAT(NOW(), '%Y%m%d')
										,DATE_FORMAT(NOW(), '%H%i%s')
									)
			ON DUPLICATE KEY UPDATE
									NICKNAME = #{nickname}
									,SEX = #{sex}
									,LANG = #{lang}
									,COUNTRY = #{country}
									,PROV = #{prov}
									,CITY = #{city}
									,PROFILE_IMG_URL = #{profileImgUrl}
	</insert>
	
	<!-- 사용자 즐겨찾기 정보 등록 -->
	<insert id="insertCustFavorite" parameterType="map">
		INSERT INTO WGTB_USER_MCHT_INFO	(
											USER_ID
											,MCHT_CD
											,REG_DT
											,REG_TM
										)
								VALUES	(
											#{userId}
											,#{mchtCd}
											,DATE_FORMAT(NOW(), '%Y%m%d')
											,DATE_FORMAT(NOW(), '%H%i%s')
										)
	</insert>
	
	<delete id="deleteCustFavorite" parameterType="map">
		DELETE FROM WGTB_USER_MCHT_INFO
		WHERE USER_ID = #{userId}
		AND MCHT_CD = #{mchtCd}
	</delete>
	
	<!-- ======================================================================================================= -->
	<!-- 											Banner 관리													 -->
	<!-- ======================================================================================================= -->
	<!-- 배너목록 조회 -->
	<select id="selectBannerList" parameterType="map" resultType="hashMap">
	
		SELECT
			*
		FROM
			WGTB_BANR_INFO A
		WHERE
			A.PST_DIV = #{adBanrTyp}
		AND
			A.ST_CD = '1'
		AND DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN A.ST_DT AND A.EN_DT
		ORDER BY A.BANR_ORDER
			
    </select>
    
    <!-- 브랜드 배너목록 조회 -->
	<select id="selectBannerListByBrId" parameterType="map" resultType="hashMap">
		(
		SELECT AD_BANR_ID
				,AD_BANR_IMG_URL
				,CONN_URL
				,AD_BANR_ORDER
		FROM EWST_AD_BANR_INFO
		WHERE OFCAL_ACCOUNT_CD = #{acntCd}
		AND AD_BANR_TYP = #{adBanrTyp}
		AND USE_YN = 'Y'
		AND DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN AD_ST_DT AND AD_EN_DT
		AND BRND_ID = (SELECT BRND_ID FROM EWST_BR_INFO T WHERE T.BR_ID = #{brId})
		)
		UNION ALL
		(
		SELECT AD_BANR_ID
				,AD_BANR_IMG_URL
				,CONN_URL
				,'100'+AD_BANR_ORDER
		FROM EWST_AD_BANR_INFO
		WHERE OFCAL_ACCOUNT_CD = #{acntCd}
		AND AD_BANR_TYP = #{adBanrTyp}
		AND USE_YN = 'Y'
		AND DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN AD_ST_DT AND AD_EN_DT
		AND AREA_CD LIKE CONCAT('%',(SELECT AREA_CD FROM EWST_BR_INFO T WHERE T.BR_ID = #{brId}),'%')
		)
		ORDER BY AD_BANR_ORDER
		LIMIT 0, 5
    </select>
    
	<!-- ======================================================================================================= -->
	<!-- 							     		 		기타 관리													 -->
	<!-- ======================================================================================================= -->
    <!-- 조회 지역명 조회 -->
	<select id="selectSearchAreaNm"  parameterType="map" resultType="hashMap">
		SELECT AREA_NM
		FROM WGTB_AREA_INFO 
		WHERE AREA_CD = #{searchAreaCd}
    </select>
    <!-- ======================================================================================================= -->
	<!-- 							     		 		검색 관리													 -->
	<!-- ======================================================================================================= -->
    
    <select id="selectSearchMchList" parameterType="map" resultType="hashMap">
    	
    	SELECT *
				,(SELECT IMG_URL FROM WGTB_MCHT_IMG_INFO WHERE MCHT_CD = A.MCHT_CD AND SEQ_NO = '1') AS MCHT_IMG
				,(SELECT IFNULL(GROUP_CONCAT(CONCAT('#', T2.TAG_NM) SEPARATOR ' '), '') FROM WGTB_MCHT_TAG_INFO T1, WGTB_TAG_INFO T2 WHERE T1.TAG_CD = T2.TAG_CD AND T1.MCHT_CD = A.MCHT_CD) AS TAG
				,(CASE WHEN (SELECT COUNT(*) FROM WGTB_USER_MCHT_INFO WHERE USER_ID = #{userId} AND MCHT_CD = A.MCHT_CD) > 0 THEN 'Y' ELSE 'N' END ) AS FVR_YN
		FROM WGTB_MCHT_INFO A
		WHERE ST_CD = '1'
		AND DIV_CD = 'M'
		AND A.MCHT_NM LIKE concat('%', #{searchNm}, '%')

    </select>
    
	<!-- ======================================================================================================= -->
	<!-- 							     		 		통계 관리													 -->
	<!-- ======================================================================================================= -->
	<!-- Page View 등록 -->
	<insert id="insertSttsPageViewInfo" parameterType="map">
	INSERT INTO WGTB_STTS_PAGE_VIEW_HIS(
									  USER_ID
									  , CMS_ID
									  , VIEW_DT
									  , VIEW_TM
									  , SRTH_NM
									  , AREA_CD
									  , MCHT_CD
									  , BANR_CD
									  , TAG_CD
									  , TOUR_CD
									  , PRMT_CD
									)VALUES (
									    #{USER_ID}
											,#{CMS_ID}
											,DATE_FORMAT(NOW(),'%Y%m%d')
											,DATE_FORMAT(NOW(),'%H%i%s')
									    ,#{SRTH_NM}
									    ,#{AREA_CD}
									    ,#{MCHT_CD}
									    ,#{BANR_CD}
									    ,#{TAG_CD}
									    ,#{TOUR_CD}
									    ,#{PRMT_CD}
									)
	</insert>
	
	<!-- 배너 View 등록 -->
	<insert id="insertSttsBannerViewInfo" parameterType="map">
		INSERT INTO WGTB_STTS_BANR_VIEW_HIS(
										  BANR_CD
										  ,USER_ID
										  ,VIEW_DT
										  ,VIEW_TM
										)VALUES (
										  #{BanrId}
										  ,#{userId}
										  ,DATE_FORMAT(NOW(),'%Y%m%d')
										  ,DATE_FORMAT(NOW(),'%H%i%s')
										)

	</insert>
	
	<!-- 배너 Click 등록 -->
	<insert id="insertSttsBannerClickInfo" parameterType="map">
		INSERT INTO WGTB_STTS_BANR_CLICK_HIS(
											BANR_CD
										  , USER_ID
										  , CLICK_DT
										  , CLICK_TM
										)VALUES (
										 	 #{bnrCd}
										    ,#{userId}
										    ,DATE_FORMAT(NOW(),'%Y%m%d')
										    ,DATE_FORMAT(NOW(),'%H%i%s')
										)
	</insert>
</mapper>